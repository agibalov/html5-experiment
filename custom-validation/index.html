<!doctype html>
<html ng-app="app">
  <head>
    <title>hello</title>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  </head>
  <body ng-controller="AppController">
    <div class="container">
      <form name="f" ng-submit="handleForm()" novalidate be="be">
        <div class="form-group" ng-class="{ 'has-error': f.username.$invalid }">
          <label for="username" class="control-label">Username</label>
          <input type="text" class="form-control" id="username" name="username" ng-model="username">          
          <p class="help-block" ng-show="f.username.$invalid">{{be.getFieldError('username')}}</p>
        </div>
        <div class="form-group" ng-class="{ 'has-error': f.password.$invalid }">
          <label for="password" class="control-label">Password</label>
          <input type="text" class="form-control" id="password" name="password" ng-model="password">
          <p class="help-block" ng-show="f.password.$invalid">{{be.getFieldError('password')}}</p>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-default">Submit</button>
        </div>
      </form>
    </div>

    <script src="bower_components/angular/angular.min.js"></script>
    <script>
      angular.module('app', [])
      .controller('AppController', function($scope, $timeout) {
        $scope.username = "loki2302";
        $scope.password = "qwerty";

        $scope.handleForm = function() {
          $scope.be.setAllFieldsValid();

          $timeout(function() {
            var errorMap = {
              'username': 'bad bad bad ' + new Date(), 
              'password': 'very bad ' + new Date()
            };

            $scope.be.setFieldErrors(errorMap);
          }, 500);
        };
      })
      .directive('be', function() {
        // use like this: <form be="be">
        // this will publish 'be' with setAllFieldsValid and setFieldErrors
        // to the related scope
        return {
          require: 'form',
          link: function(scope, element, attrs, ctrl) {
            var errors = {};
            scope[attrs.be] = {
              setAllFieldsValid: function() {
                angular.forEach(ctrl, function(formElement, fieldName) {
                  if(fieldName[0] === '$') {
                    return;
                  }

                  ctrl[fieldName].$setValidity('omg', true);              
                });
                errors = {};
              },
              setFieldErrors: function(errorMap) {
                angular.forEach(errorMap, function(message, fieldName) {
                  ctrl[fieldName].$setValidity('omg', false);
                });
                errors = errorMap;
              },
              getFieldError: function(fieldName) {
                return errors[fieldName];
              }
            };
          }
        };
      });
    </script>    
  </body>
</html>
